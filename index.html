<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kant Klao Shop</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fascinate+Inline&family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope for use in the script below
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, setLogLevel };
    </script>

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text for contrast */
            position: relative;
            overflow-x: hidden;
        }

        /* Watermark 1 with fantasy font */
        body::before {
            content: "Office job \A and \A Homework";
            white-space: pre;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            pointer-events: none;
            z-index: -1;
            font-family: 'Fascinate Inline', sans-serif;
            font-size: 12vw;
            font-weight: bold;
            color: rgba(226, 232, 240, 0.1);
            line-height: 1.2;
            text-align: center;
        }
        
        /* Watermark 2 for layer effect */
        body::after {
            content: "Digital Services";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            pointer-events: none;
            z-index: -2;
            font-family: 'Kanit', sans-serif;
            font-size: 8vw;
            font-weight: bold;
            color: rgba(226, 232, 240, 0.05);
            line-height: 1.2;
            text-align: center;
        }

        /* New colors for the dark theme */
        .bg-dark-container { background-color: #1e2a38; }
        .bg-dark-card { 
            background-color: #283544;
            border: 1px solid #3c4a5c;
        }
        .text-light-gray { color: #b0c0d0; }
        .text-accent-teal { color: #48BB78; }
        .bg-accent-teal { background-color: #48BB78; }
        .bg-accent-teal:hover { background-color: #38a169; }
        .bg-dark-input { 
            background-color: #1e2a38;
            border: 1px solid #3c4a5c;
            color: #e2e8f0;
        }

        .nav-button {
            @apply px-5 py-2 text-light-gray bg-dark-card rounded-full shadow-sm border border-gray-700 hover:bg-gray-700 hover:text-gray-200 transition-all duration-300;
        }
        .service-card {
            @apply bg-dark-card p-6 rounded-2xl shadow-md border-2 border-[#3c4a5c] hover:shadow-xl hover:-translate-y-1 transition-all duration-300;
        }
        .service-icon {
            @apply w-8 h-8 mb-4 text-accent-teal;
        }
        .contact-button {
            @apply flex items-center justify-center gap-3 px-6 py-3 text-white font-medium rounded-full shadow-lg transition-transform transform hover:scale-105;
        }
        
        /* New input field style */
        .input-field {
            background-color: #1e2a38;
            border: 1px solid #3c4a5c;
            color: #b0c0d0;
            border-radius: 0.75rem; /* rounded-xl */
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-field:focus {
            border-color: #48BB78;
            box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.5);
        }
        
        #upload-section, #contact-section, #review-board, #academic-section, #technology-section {
            background-color: #283544;
            border: 1px solid #3c4a5c;
        }
        
        /* Add a unique style for the title font */
        .unique-title-font {
            font-family: 'Fascinate Inline', sans-serif;
        }

        /* Chatbox styles */
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            border-bottom: 1px solid #3c4a5c;
            padding: 1rem;
            display: flex;
            flex-direction: column-reverse; /* New messages appear at the bottom */
        }
        .message-bubble {
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 80%;
        }
        .user-message {
            background-color: #48BB78;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }
        .dek-fao-ran-message {
            background-color: #3c4a5c;
            color: #e2e8f0;
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }
        
        /* Floating Buttons Container */
        .floating-buttons-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 1rem; /* Spacing between the buttons */
        }
        
        /* Floating Chat button */
        .floating-chat-button {
            background-color: #0d9488; /* Tailwind teal-700 */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: transform 0.3s, background-color 0.3s;
        }
        .floating-chat-button:hover {
            transform: scale(1.05);
            background-color: #115e59; /* Tailwind teal-800 */
        }
        
        /* Chat Modal */
        .chat-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .chat-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .chat-modal {
            background-color: #1e2a38;
            border: 1px solid #3c4a5c;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #e2e8f0;
            cursor: pointer;
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto px-4 py-12 max-w-6xl">
        
        <!-- Main Title -->
        <h1 class="text-6xl md:text-8xl font-bold text-center mb-16 unique-title-font text-teal-400">
            Kant Klao Shop
        </h1>

        <!-- Navigation Buttons -->
        <!-- Each button now has a 'data-target-id' attribute to link it to a section on the page -->
        <div class="flex justify-center items-center space-x-2 md:space-x-4 mb-12 flex-wrap">
            <button class="nav-button font-semibold text-teal-400 ring-2 ring-teal-500 mb-2 md:mb-0" data-target-id="all-services-section">บริการทั้งหมด</button>
            <button class="nav-button mb-2 md:mb-0" data-target-id="academic-section">ด้านวิชาการ</button>
            <button class="nav-button mb-2 md:mb-0" data-target-id="technology-section">ด้านเทคโนโลยี</button>
        </div>

        <!-- Service Cards Section - All Services -->
        <div id="all-services-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            <div class="service-card">
                <i class="fas fa-graduation-cap service-icon"></i>
                <h3 class="text-lg font-semibold mb-2">รับทำรายงาน</h3>
                <p class="text-gray-400 text-sm">รายงานทั่วไป, รายงานโครงงานนักศึกษา, กิจกรรมประจำชุดวิชา (ม.ส.ธ. และอื่น ๆ)</p>
            </div>
            
            <div class="service-card">
                <i class="fas fa-flask service-icon"></i>
                <h3 class="text-lg font-semibold mb-2">งานวิจัยและโครงงาน</h3>
                <p class="text-gray-400 text-sm">งานวิจัยและบทความวิชาการ (ป.ตรี) โครงงาน ปวส. และ ปวช.</p>
            </div>

            <div class="service-card">
                <i class="fas fa-pencil-alt service-icon"></i>
                <h3 class="text-lg font-semibold mb-2">งานเขียน</h3>
                <p class="text-gray-400 text-sm">บทความ, คอนเทนต์, บล็อก และงานเขียนอื่นๆ ตามความต้องการ</p>
            </div>

            <div class="service-card">
                <i class="fas fa-file-excel service-icon"></i>
                <h3 class="text-lg font-semibold mb-2">รับทำไฟล์ Sheet</h3>
                <p class="text-gray-400 text-sm">จัดการข้อมูลใน Spreadsheet สร้างสูตรคำนวณที่ซับซ้อน</p>
            </div>
        </div>

        <div class="flex justify-center mt-8">
            <div class="service-card w-full max-w-md">
                <i class="fas fa-code service-icon"></i>
                <h3 class="text-lg font-semibold mb-2">พัฒนาเว็บและแอปพลิเคชัน</h3>
                <p class="text-gray-400 text-sm">
                    สร้างเว็บไซต์พื้นฐาน<br>
                    สร้างแอปด้วย App Sheet, App Script<br>
                    รับเขียน Web App (งานด่วน)
                </p>
            </div>
        </div>

        <!-- ACADEMIC SERVICES SECTION -->
        <div id="academic-section" class="text-center mt-16 py-10 rounded-2xl">
            <h2 class="text-2xl font-semibold mb-2">บริการด้านวิชาการ</h2>
            <p class="text-gray-400 mb-8">
                บริการที่เกี่ยวข้องกับงานวิชาการและงานเขียน
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Academic service cards go here -->
                <div class="service-card">
                    <i class="fas fa-book-reader service-icon"></i>
                    <h3 class="text-lg font-semibold mb-2">รับทำรายงาน</h3>
                    <p class="text-gray-400 text-sm">รายงานทั่วไป, รายงานโครงงานนักศึกษา</p>
                </div>
                <div class="service-card">
                    <i class="fas fa-pen-nib service-icon"></i>
                    <h3 class="text-lg font-semibold mb-2">งานวิจัยและบทความ</h3>
                    <p class="text-gray-400 text-sm">รับทำวิจัยและบทความวิชาการ (ป.ตรี)</p>
                </div>
                <div class="service-card">
                    <i class="fas fa-file-alt service-icon"></i>
                    <h3 class="text-lg font-semibold mb-2">งานเขียนบทความ</h3>
                    <p class="text-gray-400 text-sm">บทความ, คอนเทนต์, บล็อก ตามความต้องการ</p>
                </div>
            </div>
        </div>

        <!-- TECHNOLOGY SERVICES SECTION -->
        <div id="technology-section" class="text-center mt-16 py-10 rounded-2xl">
            <h2 class="text-2xl font-semibold mb-2">บริการด้านเทคโนโลยี</h2>
            <p class="text-gray-400 mb-8">
                บริการที่เกี่ยวข้องกับการพัฒนาโปรแกรมและจัดการข้อมูล
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Technology service cards go here -->
                <div class="service-card">
                    <i class="fas fa-code service-icon"></i>
                    <h3 class="text-lg font-semibold mb-2">พัฒนา Web & App</h3>
                    <p class="text-gray-400 text-sm">สร้างเว็บไซต์พื้นฐาน, แอปด้วย App Sheet/Script</p>
                </div>
                <div class="service-card">
                    <i class="fas fa-database service-icon"></i>
                    <h3 class="text-lg font-semibold mb-2">จัดการฐานข้อมูล</h3>
                    <p class="text-gray-400 text-sm">สร้างและจัดการฐานข้อมูล, ไฟล์ Sheet</p>
                </div>
                <div class="service-card">
                    <i class="fas fa-laptop-code service-icon"></i>
                    <h3 class="text-lg font-semibold mb-2">งานโปรแกรมมิ่ง</h3>
                    <p class="text-gray-400 text-sm">เขียนโปรแกรมและสคริปต์ตามความต้องการ (งานด่วน)</p>
                </div>
            </div>
        </div>

        <!-- CONTACT US SECTION -->
        <div id="contact-section" class="text-center mt-16 py-10 rounded-2xl">
            <h2 class="text-2xl font-semibold mb-2">สนใจติดต่อสอบถาม</h2>
            <p class="text-gray-400 mb-8">รับรองผลงานคุณภาพ ตรงเวลา พร้อมให้บริการทุกความต้องการ</p>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <a href="tel:0801120371" class="contact-button bg-teal-500 hover:bg-teal-600">
                    <i class="fas fa-phone-alt"></i>
                    <span>080-1120371</span>
                </a>
                <!-- Updated Line button with the user-provided image -->
                <a href="https://lin.ee/7W36iij" target="_blank" class="contact-button bg-green-500 hover:bg-green-600 p-0">
                    <img src="https://scdn.line-apps.com/n/line_add_friends/btn/th.png" alt="เพิ่มเพื่อน" height="36" border="0">
                </a>
                <a href="https://www.facebook.com/rab.thakar.ban.rayngan.rab.tha.kickrrm.p" target="_blank" class="contact-button bg-blue-600 hover:bg-blue-700">
                    <i class="fab fa-facebook"></i>
                    <span>Facebook</span>
                </a>
                <!-- Other Services Link -->
                <a href="https://lin.ee/sjH4AZO" target="_blank" class="contact-button bg-gray-500 hover:bg-gray-600">
                    <i class="fas fa-plus-circle"></i>
                    <span>สินค้าและบริการอื่นๆ</span>
                </a>
            </div>
        </div>
        
        <!-- Review and Image Board Section -->
        <div id="review-board" class="text-center mt-16 py-10 rounded-2xl bg-dark-container border border-[#3c4a5c]">
            <h2 class="text-2xl font-semibold mb-2">บอร์ดผลงานและรีวิวจากลูกค้า</h2>
            <p class="text-gray-400 mb-8">แบ่งปันผลงานหรือรีวิวความประทับใจของคุณได้ที่นี่</p>
            
            <div class="max-w-4xl mx-auto px-4">
                <!-- Review Submission Form -->
                <form id="reviewForm" class="space-y-4 mb-8">
                    <div>
                        <input type="text" id="reviewerName" placeholder="ชื่อ (ไม่จำเป็น)" class="w-full p-3 input-field">
                    </div>
                    <div>
                        <textarea id="reviewText" placeholder="เขียนรีวิวของคุณที่นี่..." rows="4" class="w-full p-3 input-field" required></textarea>
                    </div>
                    <div>
                        <label class="block text-left text-gray-400 font-medium mb-1">
                            แนบรูปภาพ (สำหรับแสดงผลบนเครื่องเท่านั้น - ไม่ถูกอัปโหลด)
                        </label>
                        <input type="file" id="reviewImage" accept="image/*" class="w-full p-2 text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-700 file:text-teal-200 hover:file:bg-teal-600">
                    </div>
                    <div class="text-center">
                        <button type="submit" id="submitReviewBtn" class="contact-button bg-blue-600 hover:bg-blue-700 w-full sm:w-auto">
                            <i class="fas fa-comment-dots"></i>
                            <span>โพสต์รีวิว</span>
                        </button>
                    </div>
                </form>
                
                <!-- Review Display Area -->
                <div id="reviewsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <!-- Reviews will be dynamically inserted here by the script -->
                </div>
            </div>
            <div id="reviewStatus" class="mt-4 text-lg font-medium text-center"></div>
        </div>
        
        <!-- NEW HASHTAGS SECTION -->
        <div id="hashtag-section" class="text-center mt-16 py-10 rounded-2xl bg-dark-container border border-[#3c4a5c]">
            <h2 class="text-2xl font-semibold mb-2">แฮชแท็กที่เกี่ยวข้อง</h2>
            <p class="text-gray-400 mb-8">คลิกที่แฮชแท็กเพื่อเลือก จากนั้นกดปุ่มคัดลอกด้านล่างเพื่อนำไปใช้งาน</p>
            
            <!-- Loading Spinner -->
            <div id="hashtag-loading" class="text-light-gray">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-2">กำลังจัดหมวดหมู่แฮชแท็ก...</p>
            </div>

            <!-- Hashtag Container -->
            <div id="hashtag-container" class="space-y-6">
                <!-- Categorized hashtags will be inserted here by JavaScript -->
            </div>

            <!-- Copy Button -->
            <button id="copyHashtagsBtn" class="contact-button bg-purple-600 hover:bg-purple-700 mt-8 hidden">
                <i class="fas fa-copy"></i>
                <span>คัดลอกแฮชแท็กที่เลือก</span>
            </button>

            <div id="copyStatus" class="mt-4 text-sm font-medium text-center text-green-400"></div>
        </div>

    </div>
    
    <!-- Floating Buttons Container -->
    <div class="floating-buttons-container">
        <!-- New Floating Line Button -->
        <a href="https://lin.ee/7W36iij" target="_blank">
            <img src="https://scdn.line-apps.com/n/line_add_friends/btn/th.png" alt="เพิ่มเพื่อน" height="50">
        </a>
        
        <!-- Floating Chat Button -->
        <button id="floating-chat-button" class="floating-chat-button">
            <i class="fas fa-robot"></i>
            <span>สอบถาม bot เฝ้าร้าน</span>
        </button>
    </div>

    <!-- Chat Modal Overlay -->
    <div id="chat-modal-overlay" class="chat-modal-overlay">
        <div id="chat-modal" class="chat-modal">
            <button id="chat-close-button" class="close-button">&times;</button>
            <h3 class="text-lg font-semibold mb-4 text-center">ผู้ช่วยเด็กเฝ้าร้าน ประจำร้าน</h3>
            <div id="chat-box" class="chat-container w-full h-80 bg-dark-input rounded-xl mb-4 text-left">
                <!-- Chat messages will be appended here -->
            </div>
            <form id="chatForm" class="w-full flex gap-2">
                <input type="text" id="chatInput" placeholder="พิมพ์ข้อความที่นี่..." class="input-field w-full p-2 text-sm" required>
                <button type="submit" id="chatSendBtn" class="bg-accent-teal text-white p-2 rounded-lg transition-all duration-300">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
    
    <script>
        // Set the Apps Script Web App URL here
        // **IMPORTANT: REPLACE THIS URL WITH YOURS**
        const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby5l1C_S3bspMmdAfJLvBlVDRnowHLLXP6_SuHrLakc5iOMHksHd_OCjA8QUA_KQ5zc2w/exec";

        // Global variables for auto-scrolling 
        let isAutoScrollActive = true;
        let animationFrameId = null;
        let isAtEnd = false;
        let endScrollTimer = null;
        
        // --- Firebase Globals ---
        let app, db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const API_KEY = ""; // Leave this empty, it will be provided in the runtime

        // Function to display a status message
        function showStatus(elementId, message, isSuccess = true) {
            const statusDiv = document.getElementById(elementId);
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `mt-4 text-lg font-medium text-center ${isSuccess ? 'text-green-600' : 'text-red-600'}`;
            }
        }

        // Function to render a review card
        function renderReviewCard(review) {
            const reviewsContainer = document.getElementById('reviewsContainer');
            const newReview = document.createElement('div');
            newReview.className = 'bg-dark-card p-4 rounded-xl shadow-md border-2 border-[#3c4a5c] review-card';

            const name = review.name || 'ลูกค้าไม่ประสงค์ออกนาม';
            const reviewText = review.reviewText;
            const imageUrl = review.imageUrl || 'https://placehold.co/400x300/1e2a38/b0c0d0?text=ไม่มีรูปภาพ';

            newReview.innerHTML = `
                <p class="text-sm text-gray-400 mb-2">
                    เขียนโดย: <span class="font-semibold text-gray-200">${name}</span>
                </p>
                <img src="${imageUrl}" alt="Review Image" class="w-full rounded-lg mb-4">
                <p class="text-light-gray">
                    "${reviewText}"
                </p>
            `;
            reviewsContainer.prepend(newReview);
        }
        
        // Function to handle review form submission
        async function handleReviewSubmission(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitReviewBtn');
            const reviewForm = document.getElementById('reviewForm');
            const name = document.getElementById('reviewerName').value.trim() || 'ลูกค้าไม่ประสงค์ออกนาม';
            const reviewText = document.getElementById('reviewText').value.trim();
            const reviewImage = document.getElementById('reviewImage').files[0];

            if (!reviewText) {
                showStatus('reviewStatus', 'กรุณาเขียนรีวิว' , false);
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="ml-2">กำลังโพสต์...</span>';

            const reviewData = {
                name: name,
                reviewText: reviewText,
                timestamp: firebase.serverTimestamp(),
            };
            
            // Note: This example does not upload the image to a server.
            // It just logs a message for the user. To make this functional,
            // you would need to implement Firebase Storage.
            if (reviewImage) {
                console.log("Image attached, but not uploaded to the server in this version.");
                console.log("Image name:", reviewImage.name);
                reviewData.imageUrl = 'https://placehold.co/400x300/1e2a38/b0c0d0?text=Image+Not+Uploaded';
            } else {
                reviewData.imageUrl = 'https://placehold.co/400x300/1e2a38/b0c0d0?text=No+Image';
            }

            try {
                const reviewsCollectionRef = firebase.collection(db, `artifacts/${appId}/public/data/reviews`);
                await firebase.addDoc(reviewsCollectionRef, reviewData);
                showStatus('reviewStatus', 'โพสต์รีวิวสำเร็จแล้ว! ขอบคุณครับ', true);
                reviewForm.reset();
            } catch (error) {
                console.error('Error posting review:', error);
                showStatus('reviewStatus', 'เกิดข้อผิดพลาดในการโพสต์รีวิว', false);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-comment-dots"></i><span>โพสต์รีวิว</span>';
            }
        }
        
        // Function to fetch and listen for real-time reviews
        function listenForReviews() {
            const reviewsContainer = document.getElementById('reviewsContainer');
            reviewsContainer.innerHTML = ''; // Clear existing reviews
            
            const reviewsCollectionRef = firebase.collection(db, `artifacts/${appId}/public/data/reviews`);
            const q = firebase.query(reviewsCollectionRef);
            
            firebase.onSnapshot(q, (snapshot) => {
                const reviews = [];
                snapshot.forEach((doc) => {
                    reviews.push(doc.data());
                });

                // Sort reviews by timestamp in descending order in JavaScript
                reviews.sort((a, b) => {
                    if (a.timestamp && b.timestamp) {
                        return b.timestamp.toMillis() - a.timestamp.toMillis();
                    }
                    return 0;
                });

                reviewsContainer.innerHTML = ''; // Clear to prevent duplicates
                reviews.forEach(review => renderReviewCard(review));
            }, (error) => {
                console.error("Error fetching reviews:", error);
            });
        }
        
        // --- เด็กเฝ้าร้าน Chatbot Function Implementations ---

        // Function to handle chat prompt submission
        async function sendChatPrompt(prompt) {
            const chatBox = document.getElementById('chat-box');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');

            // Add user message to chatbox
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message-bubble user-message';
            userMessageDiv.textContent = prompt;
            chatBox.prepend(userMessageDiv);

            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message-bubble dek-fao-ran-message animate-pulse';
            loadingDiv.textContent = 'กำลังพิมพ์...';
            chatBox.prepend(loadingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            chatInput.value = '';
            chatInput.disabled = true;
            chatSendBtn.disabled = true;

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                const payload = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: "You are a professional shop assistant for 'Kant Klao Shop' in Thailand. Your name is 'Dek Fao Ran' (เด็กเฝ้าร้าน). Your role is to help customers, answer their questions about services, prices, and processes in a friendly and professional tone. Only provide information about the services listed on the website. Respond in Thai only." }]
                    },
                };
                
                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                // Remove loading indicator
                loadingDiv.remove();

                if (text) {
                    const dekFaoRanMessageDiv = document.createElement('div');
                    dekFaoRanMessageDiv.className = 'message-bubble dek-fao-ran-message';
                    dekFaoRanMessageDiv.textContent = text;
                    chatBox.prepend(dekFaoRanMessageDiv);
                    chatBox.scrollTop = chatBox.scrollHeight;
                } else {
                    const errorMessageDiv = document.createElement('div');
                    errorMessageDiv.className = 'message-bubble dek-fao-ran-message text-red-400';
                    errorMessageDiv.textContent = 'ขออภัย เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองอีกครั้งในภายหลัง';
                    chatBox.prepend(errorMessageDiv);
                }

            } catch (error) {
                console.error('Error with API call:', error);
                loadingDiv.remove();
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.className = 'message-bubble dek-fao-ran-message text-red-400';
                errorMessageDiv.textContent = 'ขออภัย เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองอีกครั้งในภายหลัง';
                chatBox.prepend(errorMessageDiv);
            } finally {
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase setup
            if (Object.keys(firebaseConfig).length > 0) {
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);
                firebase.setLogLevel('debug'); // For debugging

                firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User signed in with UID:", userId);
                        listenForReviews(); // Start listening for reviews after auth
                    } else {
                        // Sign in anonymously if no user is authenticated
                        try {
                            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (initialAuthToken) {
                                await firebase.signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await firebase.signInAnonymously(auth);
                            }
                            console.log("Signed in anonymously or with custom token.");
                        } catch (error) {
                            console.error("Error during authentication:", error);
                        }
                    }
                });
            } else {
                console.error("Firebase config is missing.");
                // Fallback for when Firebase isn't available in the environment
                document.getElementById('reviewForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    showStatus('reviewStatus', 'Firebase ไม่พร้อมใช้งาน' , false);
                });
            }

            // Scroll to section on navigation button click
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.currentTarget.getAttribute('data-target-id');
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Add a subtle class to highlight the section
                        targetSection.classList.add('ring-2', 'ring-teal-500', 'ring-offset-4', 'ring-offset-dark-container');
                        setTimeout(() => {
                            targetSection.classList.remove('ring-2', 'ring-teal-500', 'ring-offset-4', 'ring-offset-dark-container');
                        }, 2000);
                    }
                });
            });

            // Review form submission handler
            document.getElementById('reviewForm').addEventListener('submit', handleReviewSubmission);

            // Floating chat button functionality
            const floatingChatButton = document.getElementById('floating-chat-button');
            const chatModalOverlay = document.getElementById('chat-modal-overlay');
            const chatCloseButton = document.getElementById('chat-close-button');
            const chatForm = document.getElementById('chatForm');
            const chatInput = document.getElementById('chatInput');

            floatingChatButton.addEventListener('click', () => {
                chatModalOverlay.classList.add('active');
            });

            chatCloseButton.addEventListener('click', () => {
                chatModalOverlay.classList.remove('active');
            });

            chatModalOverlay.addEventListener('click', (e) => {
                if (e.target.id === 'chat-modal-overlay') {
                    chatModalOverlay.classList.remove('active');
                }
            });

            // Handle chat message submission
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const prompt = chatInput.value.trim();
                if (prompt) {
                    sendChatPrompt(prompt);
                }
            });
            
            // --- Hashtag Generator Logic ---
            const hashtagData = {
                "งานวิชาการ": [
                    "#รับทำรายงาน", "#รับเขียนงานวิจัย", "#งานวิชาการ", "#โครงงานนักศึกษา", "#ติวเตอร์ออนไลน์",
                    "#แก้ปัญหาการบ้าน", "#ช่วยทำรายงาน", "#รายงานด่วน"
                ],
                "งานเขียน": [
                    "#รับเขียนบทความ", "#คอนเทนต์", "#บทความการตลาด", "#เขียนบล็อก", "#รับเขียนทุกประเภท"
                ],
                "งานเทคโนโลยี": [
                    "#รับเขียนโปรแกรม", "#พัฒนาเว็บไซต์", "#ทำแอปพลิเคชัน", "#งานโปรแกรมมิ่ง", "#เขียนโค้ด",
                    "#AppSheet", "#AppScript", "#WebDesign"
                ],
                "บริการทั่วไป": [
                    "#รับทำพรีเซนต์", "#งานนำเสนอ", "#งานเร่งงานด่วน", "#รับทำทุกอย่าง", "#KantKlaoShop",
                    "#แก้ปัญหางาน"
                ]
            };
            
            const hashtagContainer = document.getElementById('hashtag-container');
            const hashtagLoading = document.getElementById('hashtag-loading');
            const copyHashtagsBtn = document.getElementById('copyHashtagsBtn');
            const copyStatus = document.getElementById('copyStatus');
            let selectedHashtags = new Set();
            
            // Function to render hashtags
            function renderHashtags() {
                hashtagLoading.classList.add('hidden');
                copyHashtagsBtn.classList.remove('hidden');
                
                for (const category in hashtagData) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'text-left';
                    categoryDiv.innerHTML = `<h3 class="text-xl font-semibold mb-2 text-teal-400">${category}</h3>`;
                    
                    const tagsDiv = document.createElement('div');
                    tagsDiv.className = 'flex flex-wrap gap-2';
                    
                    hashtagData[category].forEach(tag => {
                        const tagButton = document.createElement('button');
                        tagButton.className = 'bg-dark-input px-3 py-1 rounded-full text-sm hover:bg-teal-500 hover:text-white transition-colors duration-200';
                        tagButton.textContent = tag;
                        tagButton.addEventListener('click', () => {
                            if (selectedHashtags.has(tag)) {
                                selectedHashtags.delete(tag);
                                tagButton.classList.remove('bg-teal-500', 'text-white');
                                tagButton.classList.add('bg-dark-input', 'text-gray-200');
                            } else {
                                selectedHashtags.add(tag);
                                tagButton.classList.add('bg-teal-500', 'text-white');
                                tagButton.classList.remove('bg-dark-input', 'text-gray-200');
                            }
                        });
                        tagsDiv.appendChild(tagButton);
                    });
                    
                    categoryDiv.appendChild(tagsDiv);
                    hashtagContainer.appendChild(categoryDiv);
                }
            }
            
            // Function to copy selected hashtags to clipboard
            copyHashtagsBtn.addEventListener('click', () => {
                if (selectedHashtags.size === 0) {
                    copyStatus.textContent = 'กรุณาเลือกแฮชแท็กอย่างน้อยหนึ่งรายการ';
                    copyStatus.className = 'mt-4 text-sm font-medium text-center text-red-400';
                    return;
                }
                
                const textToCopy = Array.from(selectedHashtags).join(' ');
                
                // Using clipboard API (or a fallback)
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => {
                            copyStatus.textContent = 'คัดลอกแฮชแท็กเรียบร้อยแล้ว!';
                            copyStatus.className = 'mt-4 text-sm font-medium text-center text-green-400';
                        })
                        .catch(err => {
                            fallbackCopyTextToClipboard(textToCopy);
                        });
                } else {
                    fallbackCopyTextToClipboard(textToCopy);
                }
            });

            function fallbackCopyTextToClipboard(text) {
                const textarea = document.createElement("textarea");
                textarea.value = text;
                textarea.style.position = "fixed"; 
                textarea.style.opacity = "0"; 
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                    document.execCommand('copy');
                    copyStatus.textContent = 'คัดลอกแฮชแท็กเรียบร้อยแล้ว!';
                    copyStatus.className = 'mt-4 text-sm font-medium text-center text-green-400';
                } catch (err) {
                    copyStatus.textContent = 'ไม่สามารถคัดลอกได้: ' + err;
                    copyStatus.className = 'mt-4 text-sm font-medium text-center text-red-400';
                }
                document.body.removeChild(textarea);
            }
            
            renderHashtags();
        });
    </script>
</body>
</html>
